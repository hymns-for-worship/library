// <?xml version="1.0" encoding="utf-8" standalone="yes"?>
// <dsHymns xmlns="http://tempuri.org/dsHymns.xsd">
//   <SelectedHymnVerseTable>
//     <Hymnal>Hymns For Worship Supplement</Hymnal>
//     <Number>1072</Number>
//     <Title>Hilltops Of Glory</Title>
//     <VerseNumber>1</VerseNumber>
//     <Description>Verse 1</Description>
//     <RowNumber>0</RowNumber>
//     <Association>Hymns For Worship Supplement  1072 - Hilltops Of Glory  1</Association>
//     <SlideText></SlideText>
//   </SelectedHymnVerseTable>
//   <SelectedHymnVerseTable>
//     <Hymnal>Hymns For Worship Supplement</Hymnal>
//     <Number>1072</Number>
//     <Title>Hilltops Of Glory</Title>
//     <VerseNumber>C</VerseNumber>
//     <Description>Chorus</Description>
//     <RowNumber>1</RowNumber>
//     <Association>Hymns For Worship Supplement  1072 - Hilltops Of Glory  C</Association>
//     <SlideText></SlideText>
//   </SelectedHymnVerseTable>
//   <SelectedHymnVerseTable>
//     <Hymnal>Hymns For Worship Supplement</Hymnal>
//     <Number>1072</Number>
//     <Title>Hilltops Of Glory</Title>
//     <VerseNumber>2</VerseNumber>
//     <Description>Verse 2</Description>
//     <RowNumber>2</RowNumber>
//     <Association>Hymns For Worship Supplement  1072 - Hilltops Of Glory  2</Association>
//     <SlideText></SlideText>
//   </SelectedHymnVerseTable>
//   <SelectedHymnVerseTable>
//     <Hymnal>Hymns For Worship Supplement</Hymnal>
//     <Number>1072</Number>
//     <Title>Hilltops Of Glory</Title>
//     <VerseNumber>C</VerseNumber>
//     <Description>Chorus</Description>
//     <RowNumber>3</RowNumber>
//     <Association>Hymns For Worship Supplement  1072 - Hilltops Of Glory  C</Association>
//     <SlideText></SlideText>
//   </SelectedHymnVerseTable>
//   <SelectedHymnVerseTable>
//     <Hymnal>Hymns For Worship Supplement</Hymnal>
//     <Number>1072</Number>
//     <Title>Hilltops Of Glory</Title>
//     <VerseNumber>3</VerseNumber>
//     <Description>Verse 3</Description>
//     <RowNumber>4</RowNumber>
//     <Association>Hymns For Worship Supplement  1072 - Hilltops Of Glory  3</Association>
//     <SlideText></SlideText>
//   </SelectedHymnVerseTable>
//   <SelectedHymnVerseTable>
//     <Hymnal>Hymns For Worship Supplement</Hymnal>
//     <Number>1072</Number>
//     <Title>Hilltops Of Glory</Title>
//     <VerseNumber>C</VerseNumber>
//     <Description>Chorus</Description>
//     <RowNumber>5</RowNumber>
//     <Association>Hymns For Worship Supplement  1072 - Hilltops Of Glory  C</Association>
//     <SlideText></SlideText>
//   </SelectedHymnVerseTable>
//   <SelectedHymnVerseTable>
//     <Hymnal>Hymns For Worship Supplement</Hymnal>
//     <Number>1002</Number>
//     <Title>Higher Ground</Title>
//     <VerseNumber>1</VerseNumber>
//     <Description>Verse 1</Description>
//     <RowNumber>6</RowNumber>
//     <Association>Hymns For Worship Supplement  1002 - Higher Ground  1</Association>
//     <SlideText></SlideText>
//   </SelectedHymnVerseTable>
//   <SelectedHymnVerseTable>
//     <Hymnal>Hymns For Worship Supplement</Hymnal>
//     <Number>1002</Number>
//     <Title>Higher Ground</Title>
//     <VerseNumber>C</VerseNumber>
//     <Description>Chorus</Description>
//     <RowNumber>7</RowNumber>
//     <Association>Hymns For Worship Supplement  1002 - Higher Ground  C</Association>
//     <SlideText></SlideText>
//   </SelectedHymnVerseTable>
//   <SelectedHymnVerseTable>
//     <Hymnal>Hymns For Worship Supplement</Hymnal>
//     <Number>1002</Number>
//     <Title>Higher Ground</Title>
//     <VerseNumber>2</VerseNumber>
//     <Description>Verse 2</Description>
//     <RowNumber>8</RowNumber>
//     <Association>Hymns For Worship Supplement  1002 - Higher Ground  2</Association>
//     <SlideText></SlideText>
//   </SelectedHymnVerseTable>
//   <SelectedHymnVerseTable>
//     <Hymnal>Hymns For Worship Supplement</Hymnal>
//     <Number>1002</Number>
//     <Title>Higher Ground</Title>
//     <VerseNumber>C</VerseNumber>
//     <Description>Chorus</Description>
//     <RowNumber>9</RowNumber>
//     <Association>Hymns For Worship Supplement  1002 - Higher Ground  C</Association>
//     <SlideText></SlideText>
//   </SelectedHymnVerseTable>
//   <SelectedHymnVerseTable>
//     <Hymnal>Hymns For Worship Supplement</Hymnal>
//     <Number>1002</Number>
//     <Title>Higher Ground</Title>
//     <VerseNumber>3</VerseNumber>
//     <Description>Verse 3</Description>
//     <RowNumber>10</RowNumber>
//     <Association>Hymns For Worship Supplement  1002 - Higher Ground  3</Association>
//     <SlideText></SlideText>
//   </SelectedHymnVerseTable>
//   <SelectedHymnVerseTable>
//     <Hymnal />
//     <Number />
//     <Title>&lt;none&gt;</Title>
//     <VerseNumber>B</VerseNumber>
//     <Description />
//     <RowNumber>11</RowNumber>
//     <Association>   - &lt;none&gt;  B</Association>
//     <SlideText></SlideText>
//   </SelectedHymnVerseTable>
//   <SelectedHymnVerseTable>
//     <Hymnal />
//     <Number />
//     <Title>Hello</Title>
//     <VerseNumber>B</VerseNumber>
//     <Description />
//     <RowNumber>12</RowNumber>
//     <Association>   - Hello  B</Association>
//     <SlideText></SlideText>
//   </SelectedHymnVerseTable>
//   <SelectedHymnVerseTable>
//     <Hymnal>Hymns For Worship Supplement</Hymnal>
//     <Number>1143</Number>
//     <Title>More Precious Than Silver</Title>
//     <VerseNumber>1</VerseNumber>
//     <Description>Verse 1</Description>
//     <RowNumber>13</RowNumber>
//     <Association>Hymns For Worship Supplement  1143 - More Precious Than Silver  1</Association>
//     <SlideText></SlideText>
//   </SelectedHymnVerseTable>
//   <SelectedHymnVerseTable>
//     <Hymnal>Hymns For Worship Supplement</Hymnal>
//     <Number>1146</Number>
//     <Title>The Great Commission</Title>
//     <VerseNumber>1</VerseNumber>
//     <Description>Verse 1</Description>
//     <RowNumber>14</RowNumber>
//     <Association>Hymns For Worship Supplement  1146 - The Great Commission  1</Association>
//     <SlideText></SlideText>
//   </SelectedHymnVerseTable>
//   <SelectedHymnVerseTable>
//     <Hymnal>Hymns For Worship Supplement</Hymnal>
//     <Number>1146</Number>
//     <Title>The Great Commission</Title>
//     <VerseNumber>2</VerseNumber>
//     <Description>Verse 2</Description>
//     <RowNumber>15</RowNumber>
//     <Association>Hymns For Worship Supplement  1146 - The Great Commission  2</Association>
//     <SlideText></SlideText>
//   </SelectedHymnVerseTable>
//   <SelectedHymnVerseTable>
//     <Hymnal>Hymns For Worship Supplement</Hymnal>
//     <Number>1146</Number>
//     <Title>The Great Commission</Title>
//     <VerseNumber>3</VerseNumber>
//     <Description>Verse 3</Description>
//     <RowNumber>16</RowNumber>
//     <Association>Hymns For Worship Supplement  1146 - The Great Commission  3</Association>
//     <SlideText></SlideText>
//   </SelectedHymnVerseTable>
//   <SelectedHymnVerseTable>
//     <Hymnal>Hymns For Worship Supplement</Hymnal>
//     <Number>1146</Number>
//     <Title>The Great Commission</Title>
//     <VerseNumber>C</VerseNumber>
//     <Description>Chorus</Description>
//     <RowNumber>17</RowNumber>
//     <Association>Hymns For Worship Supplement  1146 - The Great Commission  C</Association>
//     <SlideText></SlideText>
//   </SelectedHymnVerseTable>
// </dsHymns>

import 'dart:typed_data';

import 'package:file_saver/file_saver.dart';
import 'package:xml/xml.dart';

import 'package:hfw_core/hfw_core.dart';

class SavePlaylist {
  final HfwDatabase db;
  SavePlaylist(this.db);

  Future<void> call(String userId, Playlist data) async {
    Future<XmlElement> createItem(
      PlaylistItem item,
      int index,
      String description,
      String verse,
    ) async {
      Hymn? hymn;
      if (item.hymnId != null && item.hymnId!.isNotEmpty) {
        hymn = await db.getHymn(item.hymnId!).getSingleOrNull();
      }
      Hymnal? hymnal;
      if (hymn != null) {
        hymnal = await db.getHymnalsByHymnId(hymn.id).getSingleOrNull();
      }
      final title = hymn?.title ?? item.text ?? '&lt;none&gt;';
      final hymnalName = hymnal?.name ?? '';
      return XmlElement(
        XmlName('SelectedHymnVerseTable'),
        [],
        [
          XmlElement(XmlName('Hymnal'), [], [XmlText(hymnal?.name ?? '')]),
          XmlElement(XmlName('Number'), [], [XmlText(hymn?.number ?? '')]),
          XmlElement(XmlName('Title'), [], [XmlText(title)]),
          XmlElement(XmlName('VerseNumber'), [], [XmlText(verse)]),
          XmlElement(XmlName('Description'), [], [XmlText(description)]),
          XmlElement(XmlName('RowNumber'), [], [XmlText('$index')]),
          XmlElement(XmlName('Association'), [],
              [XmlText('$hymnalName - $title - $verse'.trim())]),
          XmlElement(XmlName('SlideText'), [], [XmlText('')]),
        ],
      );
    }

    final rows = <XmlElement>[];
    final items = await db.getPlaylistItemsForPlaylist(data.id).first;

    var idx = 0;
    for (var item in items) {
      if (item.parts.isNotEmpty) {
        final parts = item.parts;
        for (final part in parts) {
          var verse = '';
          if (part.startsWith('Verse ')) {
            verse = part.split(' ').last.trim();
          } else {
            verse = part.split(' ').join('');
          }
          rows.add(await createItem(item, idx, part, verse));
        }
      } else {
        final color = item.black != null ? (item.black! ? 'B' : 'W') : '';
        rows.add(await createItem(item, idx, '', color));
      }
    }

    final xml = XmlDocument([
      XmlElement(
        XmlName('dsHymns'),
        [XmlAttribute(XmlName('xmlns'), 'http://tempuri.org/dsHymns.xsd')],
        rows,
      )
    ]);

    final str = xml.toXmlString(pretty: true, indent: '  ');

    await FileSaver.instance.saveFile(
      name: data.name,
      bytes: Uint8List.fromList(str.codeUnits),
      ext: 'hymn.xml',
      mimeType: MimeType.microsoftPresentation,
    );
  }
}
